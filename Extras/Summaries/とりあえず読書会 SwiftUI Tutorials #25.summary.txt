Transcription & Summarize : とりあえず読書会 SwiftUI Tutorials #25

はい、では今日のチュートリアルの紹介を始めていきましょう。SwiftUI チュートリアルもいよいよ終盤、そろそろ大詰めという感じです。次は Apple Watch 対応を進めていく流れになりますので、まっすぐ見ていきたいと思います。準備も問題なさそうです。では、ドキュメントを確認していきます。

前回のパート（前提条件のチェック）が終わり、続いて「Creating a watchOS App」を見ていきます。このチュートリアルは、これまでに学んだ SwiftUI の知識を、少しの作業で watchOS アプリへマイグレートできることを示す内容になっています。iOS アプリで作成した共有データやビューを活用しつつ、watchOS 向けに必要なカスタマイズを加えて、リストや詳細を表示できるようにしていく、という流れのようです。次のステップとしてスタータープロジェクトをダウンロードして進める、という前提になっています。

セクション1：watchOS ターゲットを追加する
watchOS アプリを作るために、まずはプロジェクトに watchOS ターゲットを追加します。Xcode は、watchOS 用のファイル群をプロジェクトに追加し、ビルドと実行に必要なスキームも用意してくれます。これで、同一プロジェクト内で iOS アプリと watchOS アプリの両方を作成できるようになります。

具体的には、Xcode で「File > New > Target…」を選び、テンプレート選択シートの「watchOS」タブから「App」テンプレートを選択します。このテンプレートはプロジェクトに新しい watchOS アプリを追加します。続くシートで、プロダクト名を「WatchLandmarks」にし、「watchOS App for an Existing iOS App（既存の iOS アプリ用の watchOS アプリ）」を選んで、Finish します。Xcode から `WatchLandmarks Watch App` スキームのアクティベートを促すプロンプトが出たら、Activate を押します。これで新しいターゲットで進められるようになりました。

次に、シミュレーターとして Apple Watch の 45mm デバイスを選んでおきます。では実際にやっていきます。Xcode でターゲットの追加は、画面左下のプラスからでもできますが、チュートリアルに合わせて「File > New > Target…」から進めます。間違えて「Project」を選ばないように注意ですね。ターゲットは同じプロジェクト内に新しいビルド対象を追加する操作です。

watchOS のテンプレートから「App」を選び、名前は「WatchLandmarks」とします。「Existing iOS App」を選び、ホストアプリは「Landmarks」を指定します。昔は watchOS 単体（iPhone 非必須）の構成ができなかった時期もありましたが、今は可能です。今回は「Existing iOS App」を選びます。

Bundle Identifier については、必要なら既存の iOS アプリ側の Build Settings で確認できます。基本的には自動で適切に設定されるので、そのまま進めます。ターゲットを作成すると、アクティベートの確認が出るので Activate を選択します。

watchOS のランタイムが未インストールなら、シミュレーター用にダウンロードが走ります。ダウンロードを待っている間に、watchOS ターゲットの設定を確認しておきます。General タブにある「Run without iOS App Installation（iOS アプリをインストールせずに実行）」チェックボックスを有効化します。これは、iOS アプリをインストールしなくても watchOS アプリを単体で起動できるようにするための設定です。私が触っていた当時はこうしたチェックはなかった気がしますが、今は独立実行がサポートされています。

ランタイムのダウンロードが完了したら、シミュレーターで Apple Watch の 45mm デバイスを選んで実行できる状態にしておきます。

セクション2：ファイルを共有する
ここからは、watchOS ターゲットを用意したうえで、iOS ターゲットからリソースやコードを共有していきます。Landmarks アプリのデータモデルや各種リソースファイル、そして修正なしで両プラットフォームに表示可能な再利用可能ビューなどを共有対象にします。

昔の話になりますが、watchOS アプリが iOS アプリとペアで動く必要があった頃は、ソースコードは共通でも最終的なバイナリはそれぞれ別で、同名の型でも iOS 側と watchOS 側で別物、という意識が必要でした。今でもバイナリは別である点は同じなので、そういう観点は頭の片隅に置いておくと良いと思います。

まず最初に、watchOS アプリ側に自動生成されるエントリーポイントは削除します。代わりに、Landmarks アプリと共通のエントリーポイントを共有して用います。エントリーポイントまで共有できるのはシンプルで良いですね。 まずはプロジェクトナビゲーターで、watchOS の Landmarks アプリのファイルを削除します。操作は「Move to Trash」です。「Move to Trash」と書いてあるのにメニューの色が変わらないのは、Xcode の仕様ということですね。

次に、すべてのファイル（エントリーポイントを含む）を選択して、watchOS ターゲットでも使えるようにします。既存の iOS ターゲットと共有するイメージです。プロジェクトナビゲーターでコマンドクリック（Command+クリック）で複数選択し、`LandmarkApp`、`LandmarkList`、`LandmarkRow`、`CircleImage`、`MapView` を選びます。これらのうち最初の `LandmarkApp` は、共有するアプリの定義（エントリーポイント）です。正直うまく訳せませんでしたが、要するにアプリのエントリーポイントを共有するということです。それ以外のファイルはビューで、watchOS でも特に変更なく表示に使えるものです。

今回は実作業として進めます。`watchOS Landmarks App` 側にある不要なファイルをまず削除し（Move to Trash）、次に iOS 側の `LandmarkApp`、`CircleImage`、`MapView`、`LandmarkList`、`LandmarkRow` を選んだ状態で、インスペクタの Target Membership から watchOS の Landmarks アプリのターゲットにチェックを入れます。これで大丈夫そうです。これまでリファクタリングも結構してきたので、共通化できるもの・逆に分けたほうがいいものがありそうです。このあたりは試行錯誤しながら進めましょう。

続けて、モデルのファイルも同様に追加します。コマンドクリックで `ModelData`、`Landmark`、`Hike`、`Profile` を選びます。これらはモデルデータのあらゆる側面を定義しています。watchOS ではすべての側面を使わないとしても、アプリをコンパイルするためにこれら一式が必要、という趣旨ですね。無駄なものを含めるのが少し気になりますが、今回はそういう作りという理解で進めます。

さらに、リソースも選択します。コマンドクリックで `LandmarkData.json`、`HikeData.json`、それからアセットも追加します。選択したものが watchOS アプリ側でも使えるように、`watchOS Landmarks App` のターゲットにチェックを入れます。

最後に、watchOS のアプリアイコンを、既存の iOS アプリアイコンと一致させます。watchOS の `WatchLandmarks` 側でアセットを開き、`Watch App` フォルダ内のアイコンセットに、ダウンロードしたアイコンを割り当てます。リソースの `HikeData.json` と `LandmarkData.json` も同様に `watchOS Landmarks App` に追加します。アイコン用アセットは watchOS 用の App Icon セットにドラッグして使います。

ダウンロードは先ほど（セクション1のところ）で完了していました。自動で解凍されていましたが、こういう自動展開の設定があったかどうかを少し確認しました。PC の環境を変えたばかりなので念のため見てみたのですが、Finder の設定をざっと見た範囲では特に見当たりませんでした。「解凍」「展開」などで探しましたが、出てこなかったので、ひとまずこの件は気にせず進めます。 Safariの方のせいかもしれないですね。一応見ておきましょう。設定は一般かな。展開した方が分かりやすいとは思うのですが、勝手に展開されて勝手にディスクイメージがマウントされて、そこでウイルスなどが乗ってしまっても困るので、そのあたりの話をしています。セキュリティというよりはプライバシーではないですね。ウェブサイトの項目かな。ウェブサイトのダウンロードに、これを許可するかどうかという設定がありますよね。画像は関係ないですね。詳細の中にも特に書いていないようです。まあ、いいか。

ダウンロードフォルダを指定する場所はどこでしたっけ。ここか。あ、見つかりました。「ダウンロード後、安全なファイルを開く」という項目です。安全なファイルにはムービー、ピクチャ、サウンド、テキスト、およびディスクイメージやアーカイブが含まれます。これをオフにしておけば、`zip` は手動で展開しないといけない、という状況になります。不便かどうかは分かりませんが、自分としてはこの方が良いかなという気がします。

では、リソースを投げ込みます。どっちかな。あ、今フォルダが消えましたね、きっと。`iCloud Drive`、並べ替えられないな、どうも。`LandmarkAppIcon` をドラッグして、これでOKです。アイコンを登録しました。ここまでOKですね。

ここまでビルドをやってみていいのかな。やってみましょう。ビルドをかけて…どんなエラーメッセージが出るか見たかったのですが、消えちゃいましたね。もう一回やってみても出ない。最初に出て、どこかへ行ってしまいました。まあいいか、しょうがない。

それで、`watchOS` のランドマークのカテゴリやプレビューなど、いろいろあるので少し消します。画像とか、`Image`、`Hike`、`Category`。この辺は確かに共有で使っていますね。これは `watchOS` アプリにも追加しておきます。こうですね。

これでもう一回ビルドをかけてみます。どこまで行くかな。まだありますね。`Hike` が `Codable` に準拠していない、というあたりでしょうか。まだ追い込み切れていないものがありそうです。

`Observation` はどこにある…定義をたどって探したけれど違うな。あ、これだ、`Hike` の `Observation`。これも `watchOS` に入れてあげる必要がありそうです。こんな感じで、ターゲットを `watchOS` と共通で使える良いファイルを探すときは、最初はいろいろ探していくことになるのではないかと思います。

次に、コンパイラが「`LazySequence` の要素には `magnitude` メンバーがない」といったメッセージを出しています。つまり、`Range<Double>` に `magnitude` がないということですね。`Hike` の中の `Range<Double>` に対して `magnitude` を定義しているので、これも持っていきます（`extension Range where Bound == Double { var magnitude: Double { upperBound - lowerBound } }` のようなものです）。

この調子で、まだ使えないものがいろいろありそうな気がしますが、ビルドをかけると…まだですね。`Range<Double>` がどうこう、というのは切り抜けたかな。次は `StarImage`。`StarImage` も持っていく、ということで、ここにありますね。`StarImage` も `watchOS` アプリに入れていきます。

これでビルドをかけてどうなりますかね。そろそろ…まだか。`Detail`、まずは `Detail` だけでいいか。`LandmarkDetail` も `watchOS` で使っていく…というか、ビルドには必要ですね。実際に使わなかったらそのときまた考えます。あと、`FavoriteButton` もか。いわゆるリファクタリングした都合で細かく分かれているので、最初の画面の分だけに絞っておくのは別に問題ないですよね。`StarImage` のほかに、`FavoriteButton` でした。 これもまだ良さそうですね。これでビルドをかけて……ここがプロファイルツールバー。プロファイルツールバー、あの辺かな。デフォルト、アニメーション……これは分からないか。プロファイルツールバー、どこで出てきましたっけね。あった、あったけど、どこにも……かな。プロファイルツールバー。これも watchOS に出ていく。で、ビルドってこれでどうなるかな。37.13。ビルドをモックアップと呼んでもいいのかな。これでビルドがだいぶ時間がかかっているけど、そろそろいけるってことかな。ビルドが通りましたね。次のステップへまず進みましょう。

次はディテールビューを作ります。これから、iOS ターゲットのリソース……今ありますね。これを watchOS で使うのかな。watchOS でディテールを表示するためのものですね。ディテールビューをテストするために、カスタムプレビューを、largest と smallest の Apple Watch の画面サイズそれぞれ向けに作るのかな。それで、いくつかの変更をビューに対して行い、うまくフィットするようにする感じです。そのために、watchOS にフィットするよう改良していくらしい。

まず、新しいカスタムビューとして、WatchLandmarks App フォルダに LandmarkDetail を作っていきます。このファイルは、iOS プロジェクトの同名ファイルと区別されます。iOS プロジェクトと同じ名前ですね。これは watchOS の Landmarks アプリのターゲットからだけ見えるようになります。

次に、モデルデータとランドマークと、ランドマークインデックスプロパティを LandmarkDetail のコードに追加していきます。具体的には、`ModelData` と `Landmark`、それから `landmarkIndex` プロパティですね。ここは `landmarkIndex` か。ここをコピーしようかな。インデックスを持っているのがすごく気になっているんですけど。

まずは `View` である LandmarkDetail を、watch アプリに追加して取り付けます。LandmarkDetail は View なので、`import SwiftUI` ですね。ところが、LandmarkDetail は `Invalid redeclaration` になってしまいました。さっき既存の LandmarkDetail を持ってきてしまいましたが、まだビルドが早かったということかもしれません。iOS 用の LandmarkDetail と名前が被っているので、重複していますね。

いったんビルドしていますが、LandmarkDetail のプレビューがうまくいきません。`Landmark` を渡しているあたりが原因でしょうか。この辺はまだプレビューが整っていない感じですね。これはこれで良さそうです。 テスト用に、プレビューで `ModelData` のインスタンスを作り、`Landmark` オブジェクトを `LandmarkDetail` 構造体のイニシャライザに渡します。あわせて `Environment` も設定します。具体的には、`let modelData = ModelData()` として、`modelData.landmarks.first` を使い、`.environmentObject(modelData)` を渡す形です。これでプレビューが機能するはずです。

ただ、プレビューのターゲットが watchOS ではない気がします。固定している設定を外して、まずはクリーンビルドしてみます。不足がある可能性もありますが、プレビューが表示されれば OK という感じです。ビルドに少し時間がかかりそうなので、その間に次の作業を確認します。

ステップ4として、デバイスセレクタで Apple Watch を選びます。`body` から `CircleImage` を返すようにします。ここで使う `CircleImage` は iOS プロジェクトで使っているものと同じで、リサイザブルな `Image` を作ります。`scaledToFit()` を使って、サイズをディスプレイサイズに合わせます。

まずは Apple Watch を選んで、`body` の中で `CircleImage` を返します。`CircleImage` には `landmark.image` を渡します。本来やりたいのは、`CircleImage` に対してリサイズ可能な表示をさせることですが、`.resizable()` は `Image` に対するモディファイアなので、`CircleImage` 自体にそのまま適用することはできません。ひとまずこのまま進めて、`scaledToFit()` を選びます。

`CircleImage` の場合は、`Image` を受け取るイニシャライザでビューを作り、内部で `landmark.image.resizable()` を適用する形が必要になります。`Landmark` の `image`（おそらく `Image` 型）に対して `.resizable()` を付ける場所を確認します。

このあたり、どこで見たかを思い出すためにメニューをたどります。`CircleImage` はどこに出てきたか、レイアウト周辺かもしれません。今の表示はまだ四角いままなので、`CircleImage` っぽい見た目（円形にクリップされている状態）にする処理がどこにあるかを確認します。`Detail`（ディテールビュー）はすでに作られているように見えます。`LandmarkImage` に関する記述もあり、そこではすでに `.resizable()` を使っているはずです。`LandmarkImage` 自体をどこで実装したのかを探します。

`Landmark` のロードや `ModelData` を見に行きますが、`image` の実装はそこではなさそうです。まだ `image` を持っていない可能性もあります。

関連する章をざっと振り返ると、メニューでは「Building Lists & Navigation」「Handling User Input」「Drawing Paths & Shapes」「Animation」あたりを行き来していた記憶があります。`HexagonParameters` を作ったのはパスの章でした。その前の段階、プロジェクト作成から始めた最初の方で `Image` を扱い、丸いビューにするところ（`CircleImage`）が出てきました。`MapView` を導入し、`Text` を `MapView` に差し替え、`CircleImage` を追加してパディングなどを調整したあたりで、`ModelData` を読み込む実装も進めたはずです。

いずれにせよ、今回はプレビューを watchOS に切り替え、`CircleImage` に渡す元の `Image`（例: `landmark.image`）に対して `.resizable()` と `scaledToFit()` を適切な場所で適用することで、表示サイズを合わせる方針で進めます。`LandmarkImage` や `CircleImage` の実装位置を確認し、必要なら内部で `Image` にモディファイアを付けるように修正します。最後に、`ModelData` を `Environment` に渡してプレビューが正しく動作することを確認します。 とりあえず `resizable` をどこかで使っていそうなので、調べましょう。持ってきました。とりあえず `resizable` を無理やり作って、これが iOS に影響するのかがすごく気になりますけど、どうなんでしょうね。そういったところが共通で使うときの難しいところですよね。Android側ばかりに注目して直していたら、iOS のほうでレイアウトが崩れていたり、そういったことになる恐れがあります。いじったら、その影響範囲はどこでもいつでも同じですが、影響範囲がどこまでなのかを把握して、難しいですけどやっていかないといけないという感じですね。

まだコンパイラーが出ていますね。プレビュー用のものがない、生まれていない、ソースファイルネーム……何でしょう。Build と書いてみますか。とにかくプレビューできる状況にないっぽいですね。ビルドはできるのにね。とりあえずチュートリアルを進めていってみましょうか。このメニューから、Creating a watchOS App のセクション3だったかな。セクション3、ここですね。それで追加して、モデルデータを追加して……これは前の画面でコピーしたのかな。インデックス、ランドマーク、インデックストップのね。コピーしましたね。それでプレビューも作りました。大丈夫そうですよね。

次にラージ画面を足して、返すようにして、`scaledToFill`、それと `Image` の `resizable` を足していきます。そしてデバイスセレクタ……あれ、プレビューがもしかしてもう出ているってことかな。そういうことみたいで、やっぱり失敗しているってことですね。とりあえず先に読み進めていきましょう。スモールのウォッチを選んで、スモールの画面で試して、サイズに合わせてちゃんと表示されることを確認します。常にインターフェイスをテストして、サポートするデバイスサイズすべてで表示を確認するのが肝心ですよ、みたいなことを言っています。これで追加するのかな。特にないですよね。これ、さっきまで書いていたコードですもんね。

このプレビューを……何だ？ 比べるってことかな。そういうわけでもないのか。とにかくスモールサイズでこういうふうに表示される、ということを確認せよと。そういうふうにして、無事に確定して何かやっていく前に、まずは動くところからですね。これでプレビューを動かしたときに、本当は通っているはずですよね。それなのにプレビューには出てくるし、出てきたけど何も表示されていないですね。これはアセットですね。iOS のアセットも共有するのかな。この辺を触らないと、どうにもならないですよね。

アプリアイコンがあって、これを共有していいのかなというのがとても気になっていたんですけど、まあまあやってみますか。確かに「アセットを共有する」と書いてあった気がするんですよね。これで戻って、アプリイメージで……これで画像が出てくるのかな。出てくれば期待どおりですけど。出てきた。いいですね。ラージウォッチがこれで、スモールウォッチがこれ。今、表示を頑張っていますね。これが出てくる。切って、どうなるかな。えーと、ちょっと待ってください。この状態でどうなるのかな。これでね、出てきた後に、だいたい整ってきた気がしますね。今のうちに、忘れないうちに。というのも、アプリアイコンがアセットに入っているじゃないですか。まずは大丈夫ですね。 なので、このまま使うと無駄というか、混乱を招きそうな気がします。アセットをこのまま共有に入れておくと危ないので、まずはこのアセットを複製します。`Duplicate`（複製）はどこだったかな……ショートカットは`Command+D`だったはずですが、適当なことを言ってしまいましたね。見つからなかったので手でやります。`File`メニューに`Duplicate`がありますよね。あれ、見落としているかもしれません。まあいいや、`Edit`メニューのほうにもありました。

これでアセットを追加したので、名前を「Images」みたいにしようかと思いましたが、最終的に「`Resources`」にします。`Assets` とは分けて、`Resources` にはアクセントカラーや`AppIcon`は入れないようにして、逆に `Assets` のほうにはその他の画像を入れないようにします。そして `watchOS` からは外しておく、という方針にします。これでどうなるか、`Landmark` と表示されるかを確認します。表示されるはずです。うまくいったら、分かったことは共有で伝えていきます。`AppIcon` をうっかり直してしまったら、実はそれは `iOS` のものでした、みたいなことにならないようにしたいです。なので、このように分けておくことが重要かなと思います。

あとは、`Landmarks` の `watchOS` アプリと `iOS` の両方で使う共通のものは、別のグループに入れてもいいのではないかという気がします。「`Common`」は少し分かりにくい気もしなくはないのですが、やるなら「`Landmarks iOS` は iOS 用、`Landmarks Watch` は watchOS 用」といった具合に、はっきり分けるアドバイスをしたほうが良さそうです。とりあえず今は「`Common`」という形にしておきます。

あれ、フォルダになってしまいましたね。`New Group` と `New Folder` がありましたが、今回はフォルダを作って `Common` を引っ越します。ここに共通で使うものを移動します。`Resources` もここに。これで大丈夫ですよね。`Common` 自体も `watchOS` ターゲットに追加しておけば良いはずです。どういうふうにしていくかというと、共通で使うものは順次ここへ移していきます。いつまでも `watchOS` 側や `iOS` 側の中に混在していると、どれを共通化したのか分からなくなってしまいますから。

グループを追加していきます。`Model` フォルダを作って、タイプ関連やオブザーブ関連のものを移動します。画像も、そうですね、`Landmark` とか、`Category`、`Coordinates` ですね。`ModelData` もそう、`Profile` もそうです。これらを移動しておいて、元の `Model` フォルダはもう要りません。`Resources` も両方で使うものはここに移動しておきます。

それから、`Controls` 周りも共通でしたね。`Views` の中に `Controls` フォルダを作って、`CircleImage` と `FavoriteButton` を移動します。こんな感じで `Views` の中を整理していきます。 スタイルイメージもそうだった気がします。そうですね。この辺はこっちで用意します。こちらを用意すると共用になります。それ以外は大丈夫でしょうか。大丈夫ですね。こちらを見ています。ターゲットのメンバーシップ、ランドマークのディテール、あれ、プロフィールツールバーもそうでしたか。プロフィールツールバーも同じ感じですね。

あとはランドマーク。この辺も、ということですね。ランドマークリスト、ランドマークディテールは今はありません。なので、ランドマークについては、`Views` の中に新しいフォルダーを作って `Landmarks` とし、その中に `LandmarkList` を移動します。いいですね。

`PageControl` あたりは何もいじっていません。プロフィールツールバーはビルドやトランスフォーム周りはそのままで、`Range` だけは共有していた気がします。`Range` が `Views` の中にあるのは違う気がするので、とりあえず外に出しておきます。

それから、このアプリケーションのエントリーポイントも共有したので、これも `Common` に移動しておきます。これで大丈夫でしょう。きっとこれでもビルドは通るはずです。実際にビルドをかけたところ、通りました。

ここまで来たところで、`Identifiable` をリスト用に追加したのが気になっているので、iOS 側のビューが崩れていないか確認しておきます。iOS 側だと `Landmarks`…これも名前を変えましょうか。正直面倒ではあるのですが、名前の変更は少し手間です。こちらを `Landmarks for iOS` にしてみます。

これで一旦リビルドは失敗すると思います。ランドマークの…こちらですね。`Landmarks.app`。今はビルドが失敗するはずで、`Landmarks` プロジェクトではなく、いろいろな情報を見失っているはずです。

フォルダー名は `Landmarks for iOS`。中には `Views` と `Assets` が入っています。フォルダー名は変わっています。中身も変わっていますね。アイコンなどは見失っているはずなので、このままだとダメでしょう。`AppIcon` はこれですね。ここは `AppIcon` で良くて、`Assets` のフォルダーも指定したいのですが、これは `Build Settings` で設定すれば良いと思います。`Info` には情報が入っています。

フォルダーを変えたことで認識してくれたのかもしれません。念のため一度クリーンしてからビルドしてみます。フォルダー名を変えた場合はいろいろ調整が必要な気がしますが、意外と問題ないですね。そういえばプロパティリスト（`Info.plist`）が見当たらないなと思っていました。`Info.plist` はどこでしたっけ。今見つかりません。場所が変わったのでしょうか。

`General` ももう一度見てみます。何か勝手に調整されたのか、他のターゲットのアイコンが見えなくなっているので、一度 Xcode を閉じて開き直してみます。開き直したら良くなっていますね。少し忘れていたのかもしれませんが、やはり見つかりません。最後にアイコンの確認をして、シミュレーターで実行してみます。 General と Capabilities はこのままで良さそうですが、情報はちゃんと持っていますね。あとは Resource タブ。Resource タブって何でしたっけ。まあいいか。で、Info。これはどこで持っていますよね。Build Settings。ここのフォルダーが一気に狂うと思っていたのですが、狂っていないですね。狂っているのかな。ここで `plist` とかが指定されていたと思うのですが、`Info.plist` からで良いのか。今はあって、何か変わったのでしょうか。もしかして。

探すべき場所は…こんなものですかね。プロパティリストはどこに入っているのでしょう。今はシミュレーターが全然立ち上がってこないので、まあいいか。変えて良いなら良いのですが。

そしたら、ここも Landmarks for…いや、watchOS にしたいですよね。Landmarks for watchOS。これもこうして大丈夫でしょうか。まあまあ、きっと大丈夫…きっとですね。でも何か変だな。こうするとターゲット名も変えたくなりますね。Landmarks for iOS と Landmarks、こんなに変えちゃって良いのかな。まあまあ、やってみます。

おー、watchOS。こんなふうにして。シミュレーターのほうは動いたので、シミュレーターは大丈夫ですね。その後、今ちょっとエントリーポイントが出てきていないのですが、出てきていないということは問題でしょうか。エントリーポイント自体はここですね、`LandmarksApp`。これの実際の具合を見ると、両方大丈夫ですね。うん、だから大丈夫です。もう一回ちょっと動かしてみます。シミュレーター…あ、動いた、動きました。大丈夫そうです。

でも、ちょっとつまらないので少し持っていきますが、こんな感じで動いていますね。大丈夫です。あと、スクロールもありますよね。ここをトップを見たら、大丈夫ですね。

ディテールを見たかったのですが、ディテールの `resizable` を変えたことによってどうなったか、というところです。はい、クリックできない…あ、できました。表示されている気はしますね。大丈夫でしょうか。

ではこれで良いということにして、watchOS を一応移動、というか表示させておきます。ターゲット Landmarks、このスキームも名前を変えておきますかね。Landmarks for iOS と、もう一つも Landmarks for watchOS と。よくわからないですが、大丈夫でしょう。

フォルダーのほうはツリーっぽく表示されていますね。`plist` はどこに入っているのでしょう？ というのがすごく気になっていますが、どこだろう。`plist`。あと Build Settings。Build Settings はプロジェクトに入っているから良いのか。これで `plist`。昔はこの `plist` の中に、どこだっけ…ここの `Info.plist` ファイルにパスが指定されていたはずなのですが、これがいつの間にかなくなっていますね。まあいいや。この辺は必要になったら考えましょう。

それから、バーティカルスタックをスクロールビューに追加します。View scrolling、ディスプレイの bounds。View scrolling、どういう意味でしょう。短い英語だとわからないですね。これによりスクロールビューが有効になる、あ、上のほうでやったことによる、ディスプレイの bounds の話ですね。うん。

ただ、別の問題が起こるらしいです。画像がフルサイズで表示され、`resizable` を使うと他の UI 要素や画像サイズに影響する可能性があります。もしかして iOS のほうも大きくなっているかな。ちょっと不安になってきました。一回比べてみたほうが良い気がしますね。まあ、まずは……。 とりあえず拡張されてしまってリサイズされ、他のUI要素にまで表示がはみ出してしまう状態です。`CircleImage` をちょうど `Landmark` の `name` と同じくらいのサイズ感にそろえるイメージになります。

そのために、`ScrollView` を追加して `VStack` で組み立てます。`ScrollView` の中の `VStack` に `CircleImage`、`Text`、`Toggle` などを入れていく形です。いつの間にか追加していたような気もしますが、ひとつ前の `ScrollView` のところ、具体的には `LandmarkDetail` 内で `VStack` に入れていた部分を、そのままコピーして使います。

データは `@Bindable` でモデルデータをバインドできるようにして、`body` の中に組み込みます。watchOS 用の `LandmarkDetail` の中で、`LandmarkImage` の代わりに、いまコピーした構成を入れます。画像は `resizable()` を付けてリサイズ可能にしたいのですが、うまくいかない場合があるので、とりあえずマークを入れて確認しながら進めます。`landmark.name` を表示し、`isFavorite`、`Divider`、ランドマークの `park` を表示して、`Spacer()` を置く、といったコードになっています。これらを `ScrollView` の中に入れる形で進めます。

ここで一度プレビューを止めておきます。プレビューが出てこなかったのは、単にプレビューを自分で閉じてしまっていたためです。プレビューを有効にして、まずは watchOS 側で確認します。先ほどより確かに大きく表示されているようです。いったんプレビューをロックしてから、`resizable()` の挙動を試します。`CircleImage` の中で `resizable()` を外してみると、画像が大きくなります。つまり、`resizable()` を付けておけば小さく、適切にサイズ変更されるということですね。

続いて iOS でも確認しておきます。Xcode のスキームを iOS に切り替え、iOS 側の `DetailView`（`LandmarkDetail` のプレビュー）を見ます。プレビューのロックを外して、サイズがいい具合かチェックします。ここでプレビューが出なくなり、ファイル名に関する記述のあるエラーメッセージが表示されましたが、ひとまずビルドをかけ直せば大丈夫そうです。ビルド後、あらためてプレビューを確認します。

必要に迫られて独自の `CircleImage` を作りましたが、そのプレビューでも `resizable()` を外すと画像が巨大になります。正しくは、`resizable()` を付けるとサイズが調整され、外すと巨大化する、という挙動です。以上の動作確認から、`resizable()` の付け外しで意図したサイズ調整ができていることが確認できました。 ランダムに表示されるものを確認したいので、まずは画像のサイズを固定して様子を見ます。`resizable()`を有効にすると大きくなるのかなと思いましたが、やはり大きくなりました。今のところ十分な大きさですし、大丈夫そうなので、画像はリサイズ可能にしておきます。これでいきましょう。

次に、`ScrollView`に入れて表示を確認します。うまくフィットしていない感じの画面が見えるかもしれませんが、`VStack`で包んで`ScrollView`に入れることで解消していく方針です。プログラム上の問題として、サイズが大きくなりすぎている点がありますが、ひとまずコードとしては`ScrollView`に入れて、この後に順次解消していきます。

該当箇所は、`VStack` や `NotificationView` のあたりです。`ScrollView`を入れてからの部分で、`scaledToFill()`ではなく`scaledToFit()`を選ぶように変更します。このスケール設定は、`CircleImage`の表示幅に合わせて画像を縮尺し、確実に`CircleImage`の下にランドマーク名が表示されるようにするためです。つまり、リサイズ可能な`CircleImage`に対しては、`resizable()`と`scaledToFit()`を組み合わせます。大丈夫そうですね。

ウォッチOS側のディテール画面でも、これで問題なさそうです。リファクタリングしながら進めると少しハラハラしますが、やはり学びが多いと感じます。 とりあえず画面のスケーリングを調整しないと、ただ映せば済むという話ではなくなってきます。プレビューの表示スケールは「Scale to Fit（スケールトゥーフィット）」にします、と言っていますね。いまプレビューを表示しようと頑張っているところですが、少し引っかかりました。ただ、これにしたので大丈夫だと思います。

念のためビルドをやり直してみます。ビルドをかけて成功したら、プレビューを有効化します。これで、いい感じに表示できるはずです。プレビューがまたエラーになっていますが、たぶん大丈夫でしょう。大丈夫な気がするので、表示を確認する前に進めます。

まずは Scale to Fit にして、`Divider()` を入れてから `MapView` を追加するようにしました。その後に `MapView` 側でも対応しておけばよく、`MapView` は `Landmark` の `coordinate` を取るので、`Landmark` の座標（たとえば `CLLocationCoordinate2D`）をそのまま渡せば大丈夫そうです。座標まわりでラベルの綴りを勘違いしていただけでしたが、そこは修正できています。

あとは、`NavigationStack` を用意して、バックボタンとタイトル、そしてナビゲーションタイトルとして「Landmarks」を追加すれば、他のセクションは終わりですね。まずはタイトルを設定していきましょう。`Divider()` を入れて `MapView` を置き、そのあとにナビゲーション関連を整えます。

これでプレビューできるでしょうか。プレビューがロックされていて、iOS の画面が見られない状態ですが、見られれば問題ないはずです。プレビューが失敗することもありますが、慣れの問題だと思うので注意して進めます。サイズは Scale to Fit にしたのですが、あまりフィットしている感じがしません。Large と Small を切り替えると、どちらの画面にもなっているようにも見えます。プレビュー的にはそのように見えるので、大丈夫そうですね。これでできました、ということだと思います。

ところで、ここにナビゲーションがないのですが、これはどこから見たときのプレビューでしょうか。プレビューのエントリーポイントはどこなのか、`Detail` ではなく共通の `ContentView` 側かもしれません。`ContentView` はまだ作っていないので、なんとも言えません。さっきのプレビューではボタンのラベルが出ていましたが、`navigationTitle` の設定は変えていないはずです。`LandmarkDetail` 側の `navigationTitle` は変わっていませんし、こちらにはまだナビゲーションがない状態ですね。タブもありません。これでいいのかどうかは、ひとまずそういうことにしておきます。あとはここにナビゲーションを作れば良さそうです。

`NavigationStack` を作ってあげます。バックボタンが出てくるはずですが、見えていないですね。これで良いのか、`Landmarks` のタイトルを `navigationTitle` で付けているので、一旦はこれで良いのだと思います。`navigationTitle` にオプションはなかったでしたっけ。`NavigationStack` まわりの修飾子に何かありそうです。iOS における `NavigationStack` の使い方として、スタイルや表示モードをどこかで設定できたはずです。ナビゲーションの場所や活用、修飾子としては、`navigationDestination`、`NavigationLink`、`id` などがありますが、いまの目的に対してどれを使うかはもう少し整理が必要ですね。 文字起こしのテキストを貼り付けてください。いただいた内容を「ですます調」で読みやすく整え、誤変換を修正し、コードはバックティックで装飾してそのまま残します（短いコードはインラインで表記します）。会話形式でも地の文にまとめ、途中から始まる場合は次の文から整えます。複数回に分けて送っていただいても大丈夫です。 とりあえずはこれでいいですかね。これは `navigationTitle` や `navigationBarTitleDisplayMode` の指定ですね。`NavigationStack` の中か、`navigationBarTitleDisplayMode` のあたりかもしれないです。この辺は指定しろとは言われていないので迷いますが、`NavigationStack` のここに入れれば良さそうです。`navigationBarTitleDisplayMode(.inline)` にすると、できました。こんなのでいいのかもしれませんし、ひとまずインラインでできました。まあ、これでいいでしょう。それっぽくなったので OK です。

では、リファクタリングもしたいところですが、今日はこのくらいにしておきます。次回はリファクタリングをしてから、次へ進むのが良さそうですね。ランドマークリストを追加するという話になっています。まずはリファクタリングから入っていきますか。それでは今日はこれで終わりにします。お疲れさまでした。
